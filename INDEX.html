<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Shop - Professional Auth</title>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Supabase Client from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- GOOGLE IDENTITY SERVICES (Added from your request) -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
        /* --- CSS VARIABLES & RESET --- */
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --secondary: #06b6d4;
            --bg-body: #f8fafc;
            --bg-surface: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --shadow-lg: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            --radius-sm: 6px;
            --radius-lg: 12px;
            --radius-xl: 20px; 
            --transition: all 0.6s ease-in-out;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            line-height: 1.5;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* =========================================
           AUTH SCREEN
           ========================================= */
        #auth-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f6f5f7; display: flex; justify-content: center; align-items: center; z-index: 9999;
        }

        .auth-container {
            background-color: #fff; border-radius: var(--radius-xl); box-shadow: var(--shadow-lg);
            position: relative; overflow: hidden; width: 850px; max-width: 100%; min-height: 600px;
            transition: var(--transition);
        }

        .form-container {
            position: absolute; top: 0; height: 100%; transition: all 0.6s ease-in-out;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 0 50px; text-align: center; background-color: #ffffff;
        }

        .sign-in-container { left: 0; width: 50%; z-index: 2; }
        .sign-up-container { left: 0; width: 50%; opacity: 0; z-index: 1; }

        /* Animation State */
        .auth-container.right-panel-active .sign-in-container { transform: translateX(100%); opacity: 0; z-index: 1; }
        .auth-container.right-panel-active .sign-up-container { transform: translateX(100%); opacity: 1; z-index: 5; animation: show 0.6s; }
        @keyframes show { 0%, 49.99% { opacity: 0; z-index: 1; } 50%, 100% { opacity: 1; z-index: 5; } }

        /* Overlay */
        .overlay-container { position: absolute; top: 0; left: 50%; width: 50%; height: 100%; overflow: hidden; transition: transform 0.6s ease-in-out; z-index: 100; }
        .auth-container.right-panel-active .overlay-container { transform: translateX(-100%); }

        .overlay {
            background: linear-gradient(to right, var(--primary), var(--secondary)); background-repeat: no-repeat;
            background-size: cover; background-position: 0 0; color: #ffffff; position: relative;
            left: -100%; height: 100%; width: 200%; transform: translateX(0); transition: transform 0.6s ease-in-out;
        }
        .auth-container.right-panel-active .overlay { transform: translateX(50%); }

        .overlay-panel {
            position: absolute; display: flex; align-items: center; justify-content: center; flex-direction: column;
            padding: 0 40px; text-align: center; top: 0; height: 100%; width: 50%; transform: translateX(0); transition: transform 0.6s ease-in-out;
        }
        .overlay-left { transform: translateX(-20%); }
        .auth-container.right-panel-active .overlay-left { transform: translateX(0); }
        .overlay-right { right: 0; transform: translateX(0); }
        .auth-container.right-panel-active .overlay-right { transform: translateX(20%); }

        /* Auth Typography & Inputs */
        .auth-title { font-weight: 700; margin: 0; font-size: 1.8rem; }
        .auth-paragraph { font-size: 14px; font-weight: 300; line-height: 20px; letter-spacing: 0.5px; margin: 20px 0 30px; }
        .auth-logo { font-size: 1.5rem; font-weight: 800; color: var(--primary); margin-bottom: 1.5rem; display: block; }

        .btn-auth {
            border-radius: 20px; border: 1px solid var(--primary); background-color: var(--primary);
            color: #ffffff; font-size: 12px; font-weight: bold; padding: 12px 45px;
            letter-spacing: 1px; text-transform: uppercase; transition: transform 80ms ease-in, background-color 0.2s;
            cursor: pointer; margin-top: 10px;
        }
        .btn-auth:active { transform: scale(0.95); }
        .btn-auth:hover { background-color: var(--primary-hover); }
        .btn-ghost { background-color: transparent; border-color: #ffffff; margin-top: 10px; }
        .btn-ghost:hover { background-color: rgba(255,255,255,0.2); }

        .auth-input {
            background-color: #eee; border: 1px solid transparent; padding: 12px 15px;
            margin: 8px 0; width: 100%; border-radius: 8px; outline: none; transition: 0.3s;
        }
        .auth-input:focus { background-color: #fff; border: 1px solid var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }

        /* Social Buttons Container */
        .social-container { margin: 20px 0; width: 100%; display: flex; justify-content: center; align-items: center; }
        .social {
            border: 1px solid #dddddd; border-radius: 50%; display: inline-flex;
            justify-content: center; align-items: center; margin: 0 5px; height: 40px; width: 40px;
            color: #333; text-decoration: none; font-weight: bold; font-size: 14px;
            transition: 0.3s; cursor: pointer;
        }
        .social:hover { background-color: #f1f1f1; border-color: #bbb; }

        /* Mobile Responsive */
        .mobile-switch { display: none; margin-top: 15px; font-size: 14px; color: var(--text-muted); }
        .mobile-switch span { color: var(--primary); font-weight: 600; cursor: pointer; }
        @media (max-width: 768px) {
            .auth-container { width: 100%; min-height: 100vh; border-radius: 0; box-shadow: none; }
            .form-container { width: 100%; position: relative; height: auto; padding: 40px 20px; }
            .sign-in-container, .sign-up-container { width: 100%; position: absolute; top: 0; left: 0; background: #fff; opacity: 1; transform: none !important; z-index: 1; }
            .overlay-container { display: none; }
            .sign-up-container { display: none; }
            .auth-container.mobile-signup-active .sign-in-container { display: none; }
            .auth-container.mobile-signup-active .sign-up-container { display: flex; position: relative; }
            .mobile-switch { display: block; }
        }

        /* =========================================
           MAIN APP CONTENT
           ========================================= */
        #main-app { display: none; flex-direction: column; min-height: 100vh; }
        nav { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .nav-container { max-width: 1400px; margin: 0 auto; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.5rem; font-weight: 700; color: var(--primary); text-decoration: none; letter-spacing: -0.025em; display: flex; align-items: center; gap: 0.5rem; }
        .nav-links { display: flex; gap: 2rem; list-style: none; align-items: center; }
        .nav-links a { text-decoration: none; color: var(--text-muted); font-weight: 500; font-size: 0.95rem; transition: var(--transition); cursor: pointer; }
        .nav-links a:hover { color: var(--primary); }

        /* SLIDER */
        .slider { position: relative; width: 100%; height: 400px; overflow: hidden; background: #0f172a; }
        .slide { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; transition: opacity 0.8s ease-in-out; background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; }
        .slide.active { opacity: 1; }
        .slide::after { content: ''; position: absolute; inset: 0; background: linear-gradient(to bottom, rgba(15, 23, 42, 0.4), rgba(15, 23, 42, 0.8)); }
        .slide-content { position: relative; z-index: 2; text-align: center; color: white; padding: 2rem; max-width: 800px; }
        .slide-content h2 { font-size: 2.5rem; font-weight: 800; margin-bottom: 1rem; letter-spacing: -0.05em; }
        .btn-cta { background-color: var(--primary); color: white; padding: 0.75rem 1.75rem; border-radius: var(--radius-lg); border: none; cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: var(--transition); }
        .btn-cta:hover { background-color: var(--primary-hover); transform: translateY(-2px); }

        /* PRODUCTS */
        .container { max-width: 1400px; margin: 3rem auto; padding: 0 1.5rem; flex: 1; }
        .section-title { text-align: center; margin-bottom: 2rem; font-size: 2rem; font-weight: 700; color: var(--text-main); }
        .product-grid { display: flex; flex-direction: row; overflow-x: auto; gap: 1.5rem; padding: 1rem 0.5rem 2.5rem 0.5rem; scroll-snap-type: x mandatory; }
        .product-grid::-webkit-scrollbar { height: 8px; }
        .product-grid::-webkit-scrollbar-track { background: transparent; }
        .product-grid::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
        .product-card { background: var(--bg-surface); border-radius: var(--radius-lg); overflow: hidden; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); transition: var(--transition); display: flex; flex-direction: column; border: 1px solid var(--border); min-width: 260px; max-width: 260px; flex-shrink: 0; scroll-snap-align: start; }
        .product-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .product-img { width: 100%; height: 200px; object-fit: cover; }
        .product-info { padding: 1rem; display: flex; flex-direction: column; flex-grow: 1; }
        .product-title { font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; line-height: 1.3; }
        .product-price { color: var(--primary); font-size: 1.1rem; font-weight: 700; margin-bottom: 1rem; }
        .btn-buy { margin-top: auto; width: 100%; padding: 0.5rem; background-color: transparent; border: 2px solid var(--border); color: var(--text-main); font-weight: 600; border-radius: var(--radius-sm); cursor: pointer; transition: var(--transition); }
        .btn-buy:hover { background-color: var(--text-main); color: white; }

        /* FOOTER */
        footer { background-color: var(--text-main); color: #94a3b8; padding: 3rem 1.5rem; text-align: center; }

        /* MODALS & FORMS */
        .form-group { margin-bottom: 1.25rem; text-align: left; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.875rem; }
        .form-control { width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: 1rem; transition: var(--transition); }
        .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .btn-submit { width: 100%; padding: 0.875rem; background-color: var(--primary); color: white; border: none; border-radius: var(--radius-lg); font-weight: 600; cursor: pointer; display: flex; justify-content: center; gap: 0.5rem; }
        .btn-submit:hover { background-color: var(--primary-hover); }
        .btn-submit:disabled { opacity: 0.7; cursor: not-allowed; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: var(--transition); }
        .modal-overlay.open { opacity: 1; visibility: visible; }
        .modal-content { background: var(--bg-surface); padding: 2.5rem; border-radius: var(--radius-lg); width: 90%; max-width: 500px; position: relative; max-height: 90vh; overflow-y: auto; transform: scale(0.95); transition: var(--transition); }
        .modal-overlay.open .modal-content { transform: scale(1); }
        .close-modal { position: absolute; top: 1.5rem; right: 1.5rem; font-size: 1.5rem; cursor: pointer; background: none; border: none; }

        .order-table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.9rem; }
        .order-table th, .order-table td { text-align: left; padding: 1rem; border-bottom: 1px solid var(--border); }
        .order-table th { background-color: #f8fafc; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; }

        /* TOAST */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
        .toast { min-width: 300px; padding: 1rem; background: white; border-radius: var(--radius-lg); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-left: 4px solid var(--primary); animation: slideIn 0.3s ease-out; font-weight: 500; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body>

    <!-- =========================================
         AUTH SCREEN
         ========================================= -->
    <div id="auth-screen">
        
        <!-- GOOGLE ONLOAD DIV (From your code) -->
        <div id="g_id_onload"
             data-client_id="652826869991-oi3pd0r0v4f79ovj1uceg8j174ue05ik.apps.googleusercontent.com"
             data-callback="handleCredentialResponse"
             data-auto_prompt="false">
        </div>

        <div class="auth-container" id="authContainer">
            
            <!-- SIGN UP FORM -->
            <div class="form-container sign-up-container">
                <form id="signupForm">
                    <span class="auth-logo">⚡ ModernShop</span>
                    <h1 class="auth-title">Create Account</h1>
                    <div class="social-container">
                        <!-- OFFICIAL GOOGLE BUTTON (For Signup) -->
                        <div class="g_id_signin" 
                             data-type="standard" 
                             data-size="large" 
                             data-theme="outline" 
                             data-text="sign_up_with" 
                             data-shape="circle" 
                             data-logo_alignment="center">
                        </div>
                        <a href="#" class="social">F</a>
                        <a href="#" class="social">in</a>
                    </div>
                    <span class="auth-paragraph">or use your email for registration</span>
                    
                    <input type="text" id="signupName" class="auth-input" placeholder="Full Name" required />
                    <input type="tel" id="signupMobile" class="auth-input" placeholder="Mobile Number" required />
                    <input type="email" id="signupEmail" class="auth-input" placeholder="Email" required />
                    <input type="password" id="signupPassword" class="auth-input" placeholder="Password" required />
                    
                    <button type="submit" class="btn-auth" id="btnSignup">Sign Up</button>
                    
                    <div class="mobile-switch">
                        Already have an account? <span onclick="toggleAuth('login')">Sign In</span>
                    </div>
                </form>
            </div>

            <!-- SIGN IN FORM -->
            <div class="form-container sign-in-container">
                <form id="loginForm">
                    <span class="auth-logo">⚡ ModernShop</span>
                    <h1 class="auth-title">Sign in</h1>
                    <div class="social-container">
                        <!-- OFFICIAL GOOGLE BUTTON (For Login) -->
                        <div class="g_id_signin" 
                             data-type="standard" 
                             data-size="large" 
                             data-theme="outline" 
                             data-text="signin_with" 
                             data-shape="circle" 
                             data-logo_alignment="center">
                        </div>
                        <a href="#" class="social">F</a>
                        <a href="#" class="social">in</a>
                    </div>
                    <span class="auth-paragraph">or use your account</span>
                    
                    <input type="email" id="loginEmail" class="auth-input" placeholder="Email" required />
                    <input type="password" id="loginPassword" class="auth-input" placeholder="Password" required />
                    
                    <a href="#" style="font-size: 12px; color: #333; margin: 15px 0; text-decoration: none;">Forgot your password?</a>
                    <button type="submit" class="btn-auth" id="btnLogin">Sign In</button>

                    <div class="mobile-switch">
                        First time here? <span onclick="toggleAuth('signup')">Sign Up</span>
                    </div>
                </form>
            </div>

            <!-- OVERLAY CONTAINER -->
            <div class="overlay-container">
                <div class="overlay">
                    <div class="overlay-panel overlay-left">
                        <h1 class="auth-title">Welcome Back!</h1>
                        <p class="auth-paragraph">To keep connected with us please login with your personal info</p>
                        <button class="btn-auth btn-ghost" id="signIn">Sign In</button>
                    </div>
                    <div class="overlay-panel overlay-right">
                        <h1 class="auth-title">Hello, Friend!</h1>
                        <p class="auth-paragraph">Enter your personal details and start your journey with us</p>
                        <button class="btn-auth btn-ghost" id="signUp">Sign Up</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- =========================================
         MAIN APP CONTENT
         ========================================= -->
    <div id="main-app">
        <nav>
            <div class="nav-container">
                <a href="#" class="logo"><span>⚡</span> ModernShop</a>
                <ul class="nav-links">
                    <li><a href="#">Home</a></li>
                    <li><a href="#products">Products</a></li>
                    <li><a id="historyLink" onclick="handleHistoryClick()">My Orders</a></li>
                    <li><a id="logoutLink" onclick="handleLogout()" style="color:var(--error)">Logout</a></li>
                </ul>
            </div>
        </nav>

        <section class="slider" id="home">
            <div class="slide active" style="background-image: url('https://picsum.photos/seed/tech1/1600/900');">
                <div class="slide-content">
                    <h2>Next Gen Tech</h2>
                    <p>Exclusive access for members.</p>
                    <button class="btn-cta" onclick="document.getElementById('products').scrollIntoView({behavior: 'smooth'})">Shop Now</button>
                </div>
            </div>
            <div class="slide" style="background-image: url('https://picsum.photos/seed/setup/1600/900');">
                <div class="slide-content">
                    <h2>Super Sale</h2>
                    <p>Members only pricing.</p>
                    <button class="btn-cta" onclick="document.getElementById('products').scrollIntoView({behavior: 'smooth'})">View Deals</button>
                </div>
            </div>
        </section>

        <div class="container" id="products">
            <h2 class="section-title">Curated Products</h2>
            <div class="product-grid" id="productGrid"></div>
        </div>

        <footer>
            <div style="max-width: 1200px; margin: 0 auto;">
                <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">ModernShop</p>
                <p style="font-size: 0.875rem;">&copy; 2023 ModernShop Inc. All rights reserved.</p>
            </div>
        </footer>
    </div> 

    <!-- =========================================
         MODALS
         ========================================= -->
    <div class="modal-overlay" id="orderModal">
        <div class="modal-content">
            <button class="close-modal" id="closeOrderModal">&times;</button>
            <h3 style="margin-bottom: 0.5rem;">Checkout</h3>
            <div id="modalProductSummary" style="margin-bottom:1.5rem; padding:1rem; background:#f8fafc; border-radius:var(--radius-lg); border:1px solid var(--border); display:flex; align-items:center; gap:1rem;"></div>
            <form id="orderForm">
                <div class="form-group"><label>Email</label><input type="email" id="orderEmail" class="form-control" readonly style="background:#f1f5f9; cursor:not-allowed;"></div>
                <div class="form-group"><label for="customerName">Full Name</label><input type="text" id="customerName" class="form-control" required></div>
                <div class="form-group"><label for="phoneNumber">Phone Number</label><input type="tel" id="phoneNumber" class="form-control" required></div>
                <div class="form-group"><label>Quantity</label><input type="number" id="quantity" class="form-control" min="1" value="1" required></div>
                <div class="form-group"><label>Payment Method</label><select id="paymentMethod" class="form-control"><option value="Cash on Delivery">Cash on Delivery</option><option value="Online">Credit Card / Online</option></select></div>
                <button type="submit" class="btn-submit" id="submitBtn">Confirm Order</button>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="historyModal">
        <div class="modal-content" style="max-width: 800px;">
            <button class="close-modal" onclick="document.getElementById('historyModal').classList.remove('open')">&times;</button>
            <h3 style="margin-bottom: 1.5rem;">Order History</h3>
            <div id="historyContainer" style="overflow-x:auto;"></div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script>
        // ============================================================
        // CONFIGURATION
        // ============================================================
        const SUPABASE_URL = 'https://rkjavjrfxtaastaouedq.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_FsxRVm4qjVcRs78cKHLhAw_4yxLDlfi'; 

        let db;
        let currentUser = null;

        try {
            if (window.supabase) {
                db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                
                db.auth.onAuthStateChange((event, session) => {
                    if (event === 'SIGNED_IN') {
                        currentUser = session.user;
                        unlockApp();
                    } else if (event === 'SIGNED_OUT') {
                        currentUser = null;
                        lockApp();
                    }
                });
            } else {
                alert("Error: Supabase library failed to load.");
            }
        } catch (e) {
            alert("Connection Error: " + e.message);
        }

        const products = [
            { id: 1, name: "Wireless Noise Cancelling Headphones", price: 299, img: "https://picsum.photos/seed/headphone/400/300" },
            { id: 2, name: "Series 7 Smart Watch", price: 399, img: "https://picsum.photos/seed/watch/400/300" },
            { id: 3, name: "Ultra-Running Shoes", price: 120, img: "https://picsum.photos/seed/shoes/400/300" },
            { id: 4, name: "Travel Backpack", price: 85, img: "https://picsum.photos/seed/bag/400/300" },
            { id: 5, name: "Aviator Sunglasses", price: 150, img: "https://picsum.photos/seed/glasses/400/300" },
            { id: 6, name: "50mm Prime Lens", price: 199, img: "https://picsum.photos/seed/lens/400/300" },
            { id: 7, name: "Pro Gaming Mouse", price: 75, img: "https://picsum.photos/seed/mouse/400/300" },
            { id: 8, name: "Mechanical Keyboard", price: 140, img: "https://picsum.photos/seed/keyboard/400/300" }
        ];

        // --- CORE FUNCTIONS ---
        async function init() {
            renderProducts();
            startSlider();
            const { data: { session } } = await db.auth.getSession();
            if (session) {
                currentUser = session.user;
                unlockApp();
            } else {
                lockApp();
            }
        }

        // --- AUTH ANIMATION LOGIC ---
        const signUpButton = document.getElementById('signUp');
        const signInButton = document.getElementById('signIn');
        const authContainer = document.getElementById('authContainer');

        if(signUpButton) signUpButton.addEventListener('click', () => authContainer.classList.add("right-panel-active"));
        if(signInButton) signInButton.addEventListener('click', () => authContainer.classList.remove("right-panel-active"));

        window.toggleAuth = function(mode) {
            if (mode === 'signup') authContainer.classList.add("mobile-signup-active");
            else authContainer.classList.remove("mobile-signup-active");
        };

        function unlockApp() {
            document.getElementById('auth-screen').style.display = 'none';
            const app = document.getElementById('main-app');
            app.style.display = 'flex';
            app.classList.add('fade-in');
        }

        function lockApp() {
            document.getElementById('auth-screen').style.display = 'flex';
            document.getElementById('main-app').style.display = 'none';
        }

        // --- GOOGLE LOGIN LOGIC (Updated with Supabase Integration) ---
        async function handleCredentialResponse(response) {
            try {
                showToast("Logging in with Google...");

                // Send the Google Token to Supabase to create a session
                const { data, error } = await db.auth.signInWithIdToken({
                    provider: 'google',
                    token: response.credential,
                });

                if (error) throw error;

                // Success is handled by onAuthStateChange -> unlockApp()
            } catch (err) {
                console.error("Google Login Error:", err);
                showToast("Google Login Failed: " + err.message);
            }
        }

        // --- EMAIL SIGN UP ---
        document.getElementById('signupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('signupName').value;
            const mobile = document.getElementById('signupMobile').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const btn = document.getElementById('btnSignup');
            
            btn.disabled = true;
            btn.innerHTML = 'Creating Account...';

            const { error } = await db.auth.signUp({
                email: email,
                password: password,
                options: {
                    data: { full_name: name, mobile_number: mobile }
                }
            });

            if (error) {
                showToast("Error: " + error.message);
                btn.disabled = false;
                btn.innerHTML = 'Sign Up';
            } else {
                showToast("Account created! You are logged in.");
            }
        });

        // --- EMAIL LOGIN ---
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const btn = document.getElementById('btnLogin');
            
            btn.disabled = true;
            btn.innerHTML = 'Logging in...';

            const { error } = await db.auth.signInWithPassword({ email, password });

            if (error) {
                showToast("Login Failed: " + error.message);
                btn.disabled = false;
                btn.innerHTML = 'Sign In';
            }
        });

        async function handleLogout() {
            await db.auth.signOut();
        }

        // --- UI RENDERERS ---
        function renderProducts() {
            const grid = document.getElementById('productGrid');
            if(!grid) return; 
            grid.innerHTML = products.map(p => `
                <div class="product-card">
                    <img src="${p.img}" class="product-img" alt="${p.name}">
                    <div class="product-info">
                        <h3 class="product-title">${p.name}</h3>
                        <div class="product-price">$${p.price}</div>
                        <button class="btn-buy" onclick="openOrderModal(${p.id})">Order Now</button>
                    </div>
                </div>
            `).join('');
        }

        function startSlider() {
            let idx = 0;
            const slides = document.querySelectorAll('.slide');
            if(slides.length === 0) return;
            setInterval(() => {
                slides[idx].classList.remove('active');
                idx = (idx + 1) % slides.length;
                slides[idx].classList.add('active');
            }, 5000);
        }

        window.openOrderModal = function(id) {
            const product = products.find(p => p.id === id);
            if(!product) return;
            document.getElementById('productName').value = product.name;
            document.getElementById('orderEmail').value = currentUser.email;
            
            const summaryDiv = document.getElementById('modalProductSummary');
            if(summaryDiv) {
                summaryDiv.innerHTML = `
                    <img src="${product.img}" style="width:50px;height:50px;object-fit:cover;border-radius:var(--radius-sm);">
                    <div>
                        <div style="font-weight:600;">${product.name}</div>
                        <div style="color:var(--primary);font-weight:700;">$${product.price}</div>
                    </div>
                `;
            }
            document.getElementById('orderModal').classList.add('open');
        };

        document.getElementById('closeOrderModal').onclick = () => {
            document.getElementById('orderModal').classList.remove('open');
            document.getElementById('orderForm').reset();
        };

        document.getElementById('orderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.textContent = "Processing...";
            btn.disabled = true;

            const orderData = {
                customer_name: document.getElementById('customerName').value,
                phone_number: document.getElementById('phoneNumber').value,
                product_name: document.getElementById('productName').value,
                quantity: parseInt(document.getElementById('quantity').value),
                payment_method: document.getElementById('paymentMethod').value,
                status: 'pending',
                email: currentUser.email,
                user_id: currentUser.id 
            };

            const { error } = await db.from('orders').insert([orderData]);

            if (error) {
                showToast("Order Failed: " + error.message);
                btn.textContent = "Confirm Order";
                btn.disabled = false;
            } else {
                showToast("Order placed successfully!");
                document.getElementById('orderModal').classList.remove('open');
                document.getElementById('orderForm').reset();
                btn.textContent = "Confirm Order";
                btn.disabled = false;
            }
        });

        function handleHistoryClick() {
            fetchOrderHistory();
            document.getElementById('historyModal').classList.add('open');
        }
        
        async function fetchOrderHistory() {
            const container = document.getElementById('historyContainer');
            container.innerHTML = '<p>Loading...</p>';
            const { data, error } = await db.from('orders').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false });

            if (error || !data || data.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--text-muted)">No orders found.</div>';
                return;
            }

            let html = `<table class="order-table"><thead><tr><th>Product</th><th>Date</th><th>Qty</th><th>Status</th></tr></thead><tbody>`;
            data.forEach(order => {
                html += `<tr><td>${order.product_name}</td><td>${new Date(order.created_at).toLocaleDateString()}</td><td>${order.quantity}</td><td><span style="padding:2px 8px;border-radius:10px;background:#dcfce7;color:#166534;font-size:0.8rem;text-transform:uppercase;font-weight:700;">${order.status}</span></td></tr>`;
            });
            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        function showToast(msg) {
            const container = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = 'toast';
            t.innerText = msg;
            container.appendChild(t);
            setTimeout(() => {
                t.style.opacity = '0'; t.style.transform = 'translateX(100%)';
                setTimeout(() => t.remove(), 300);
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>